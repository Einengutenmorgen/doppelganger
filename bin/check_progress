#!/bin/bash
# Script to check the progress of the persona variation pipeline

OUTPUT_FILE=${1:-"./results/persona_variations.jsonl"}

if [ ! -f "$OUTPUT_FILE" ]; then
  echo "Error: Output file not found at $OUTPUT_FILE"
  echo "Usage: $0 [path_to_output_file]"
  exit 1
fi

# Count the number of completed users
NUM_USERS=$(grep -c "\"status\": \"completed\"" "$OUTPUT_FILE")

# Count the total number of synthetic posts generated
NUM_POSTS=$(grep -o "\"fields_used\"" "$OUTPUT_FILE" | wc -l)

# Get the timestamp of the most recent entry
LAST_TIMESTAMP=$(grep -o "\"timestamp\": \"[^\"]*\"" "$OUTPUT_FILE" | tail -n 1 | cut -d '"' -f 4)

echo "===== Pipeline Progress ====="
echo "Output file: $OUTPUT_FILE"
echo "Completed users: $NUM_USERS"
echo "Total posts generated: $NUM_POSTS"
echo "Last update: $LAST_TIMESTAMP"
echo "==========================="

# Check if there are any temporary files (in-progress users)
TEMP_FILES=$(find "$(dirname "$OUTPUT_FILE")" -name "*.temp" | wc -l)
if [ "$TEMP_FILES" -gt 0 ]; then
  echo "Found $TEMP_FILES temporary files (users in progress)"
fi